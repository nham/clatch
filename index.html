<html>
  <head>
    <title>Clatch</title>
    <script src="lib/react-0.10.0.js"></script>
    <script src="lib/JSXTransformer-0.10.0.js"></script>
    <script src="lib/jquery-2.1.0.js"></script>
    <script src="lib/director.min.js"></script>
    <link rel="stylesheet" href="css/style.css">
  </head>
  <body>
    <div id="content"></div>
    <script type="text/jsx" src="logdisplay.jsx"></script>
    <script type="text/jsx" src="logentryform.jsx"></script>
    <script type="text/jsx">
      /**
       * @jsx React.DOM
       */
      
      (function() {
          var clatch = {};
          clatch.loglist = 'loglist';
          clatch.newlog = 'newlog';
          clatch.editlog = 'editlog';
          clatch.newpage = 'newpage';
          clatch.editpage = 'editpage';

          var Clatch = React.createClass({
            getInitialState: function() {
                return {
                    nowShowing: 'loglist',
                    data: []
                };
            },

            componentWillMount: function() {
                $.ajax({
                  url: this.props.url,
                  dataType: 'json',
                  success: function(data) {
                    this.setState({nowShowing: this.state.nowShowing, data: data});
                  }.bind(this),
                  error: function(xhr, status, err) {
                    console.error(this.props.url, status, err.toString());
                  }.bind(this)
                });
              },

            componentDidMount: function () {
                var setState = this.setState;
                var boundSetState = setState.bind(this);

                var router = Router({
                    '/': setState.bind(this, {nowShowing: clatch.loglist}),
                    '/log/new': setState.bind(this, {nowShowing: clatch.newlog}),
                    '/log/edit/:id': function(id) { 
                                            boundSetState({nowShowing: clatch.editlog,
                                                           id: id}); 
                                        }
                    });
                router.init('/');
            },

            render: function() {
                console.log(this.state.nowShowing);
                if (this.state.nowShowing === clatch.loglist) {

                    return <LogDisplay entries={this.state.data}/>;

                } else if (this.state.nowShowing === clatch.newlog) {

                    return <LogForm />;

                } else if (this.state.nowShowing === clatch.editlog) {

                    var id = parseInt(this.state.id, 10);
                    var entry = this.state.data.filter(function(entry) { 
                                    return entry['id'] === id;
                    });
                    return <LogForm entry={entry[0]} id={this.state.id} />;

                }
            }
          });

          React.renderComponent(
            <Clatch url="entries.json" />,
            document.getElementById('content')
          );

    })();
    </script>
  </body>
</html>
