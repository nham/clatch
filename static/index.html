<html>
  <head>
    <title>Clatch</title>
    <script src="/static/react-0.10.0.js"></script>
    <script src="/static/JSXTransformer-0.10.0.js"></script>
    <script src="/static/jquery-2.1.0.js"></script>
    <script src="/static/director.min.js"></script>
    <script src="/static/moment.min.js"></script>
    <link rel="stylesheet" href="/static/style.css">
  </head>
  <body>
    <div id="content"></div>
    <script type="text/jsx" src="/static/logdisplay.jsx"></script>
    <script type="text/jsx" src="/static/logentryform.jsx"></script>
    <script type="text/jsx">
/**
* @jsx React.DOM
*/

(function() {
  var clatch = {};
  clatch.loglist = 'loglist';
  clatch.newlog = 'newlog';
  clatch.editlog = 'editlog';
  clatch.newpage = 'newpage';
  clatch.editpage = 'editpage';

  var Clatch = React.createClass({
    getInitialState: function() {
        return {
            nowShowing: 'loglist',
            data: []
        };
    },

    handleFormSubmit: function(logEntry) {
        // TODO: make this alternatively POST or PUT depending on whether its edit form or new form
        console.log(logEntry);
        $.ajax({
          url: '/logs',
          contentType: 'application/json',
          type: 'POST',
          data: JSON.stringify({'body': logEntry.body, 'tags': logEntry.tags}),
          success: function(data) {
            console.log(data);
          }.bind(this),
          error: function(xhr, status, err) {
            console.error(this.props.url, status, err.toString());
          }.bind(this)
        });
      },

    componentWillMount: function() {
        $.ajax({
          url: this.props.url,
          dataType: 'json',
          success: function(data) {
            console.log("success is my only motherfucking option");
            console.log(data);
            this.setState({nowShowing: this.state.nowShowing, data: data['logs']});
          }.bind(this),
          error: function(xhr, status, err) {
            console.error(this.props.url, status, err.toString());
          }.bind(this)
        });
      },

    componentDidMount: function () {
        var setState = this.setState;
        var boundSetState = setState.bind(this);

        var router = Router({
            '/': setState.bind(this, {nowShowing: clatch.loglist}),
            '/log/new': setState.bind(this, {nowShowing: clatch.newlog}),
            '/log/edit/:id': function(id) { 
                                    boundSetState({nowShowing: clatch.editlog,
                                                   id: id}); 
                                }
            });
        router.init('/');
    },

    render: function() {
        console.log(this.state.nowShowing);
        if (this.state.nowShowing === clatch.loglist) {

            return <LogDisplay entries={this.state.data}/>;

        } else if (this.state.nowShowing === clatch.newlog) {

            return <LogForm onFormSubmit={this.handleFormSubmit} />;

        } else if (this.state.nowShowing === clatch.editlog) {

            var id = parseInt(this.state.id, 10);
            var entry = this.state.data.filter(function(entry) { 
                            return entry['id'] === id;
            });

            return <LogForm entry={entry[0]} id={this.state.id} 
                            onFormSubmit={this.handleFormSubmit} />;

        }
    }
  });

  React.renderComponent(
    <Clatch url="/logs" />,
    document.getElementById('content')
  );

})();
    </script>
  </body>
</html>
